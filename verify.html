<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Visual Director Verification</title>
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }

        .pass {
            color: #4caf50;
        }

        .fail {
            color: #f44336;
        }

        .test-block {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
    </style>

    <!-- Import Skills -->
    <script src=".agent/skills/story-analysis/scripts/visual-translator.js"></script>
    <script src=".agent/skills/story-analysis/scripts/token-optimizer.js"></script>
    <script src=".agent/skills/story-analysis/scripts/style-manager.js"></script>
    <script src=".agent/skills/story-analysis/scripts/story-state.js"></script>
</head>

<body>
    <h1>Verification Check</h1>
    <div id="results">Running tests...</div>

    <script>
        const results = document.getElementById('results');
        const logs = [];

        function assert(desc, condition) {
            const status = condition ? "PASS" : "FAIL";
            const css = condition ? "pass" : "fail";
            logs.push(`<div class="test-block ${css}">[${status}] ${desc}</div>`);
            console.log(`[${status}] ${desc}`);
        }

        window.onload = () => {
            try {
                // 1. Test Visual Translator
                const vt = new VisualTranslator();
                const abstract = "The angry detective";
                const concrete = vt.translate(abstract);
                assert("Visual Translator: Maps 'angry' to concrete visuals", concrete.includes("clenched fists") || concrete.includes("red face"));

                // 2. Test Token Optimizer
                const to = new TokenOptimizer();
                const fluffy = "The very mysterious style of the scene is basically dark.";
                const clean = to.optimize(fluffy);
                assert("Token Optimizer: Removes 'The', 'very', 'style of'", !clean.includes("The") && !clean.includes("very") && !clean.includes("style of"));
                assert("Token Optimizer: Keeps 'dark'", clean.includes("dark"));

                // 3. Test Style Manager
                const sm = new StyleManager();
                const negatives = sm.getNegatives("anime");
                assert("Style Manager: Returns 'photorealistic' as negative for anime", negatives.includes("photorealistic"));

                // 4. Test Story State (Entity Encapsulation)
                const storyText = "The lazy Detective sat down. He was tired.";
                const state = new StoryState(storyText);
                const char = state.characters[0];
                assert("Story State: Extracts 'Detective'", char && char.name === "Detective");
                // Note: The simple regex in StoryState looks for adjectives in pre-context. "lazy" is before "Detective".
                assert("Story State: Captures attribute 'lazy'", char && char.attributes.includes("lazy"));

                // 5. Test Story State (Scene Hierarchy)
                const sceneText = "The hero enters the Kitchen. He cuts vegetables. Then he goes Outside. It starts raining.";
                const state2 = new StoryState(sceneText);
                const scenes = state2.scenes;
                assert("Story State: Segments into multiple scenes", scenes.length >= 2);
                assert("Story State: correctly identifies context 'Kitchen'", scenes.some(s => s.context === "Kitchen"));
                assert("Story State: correctly identifies context 'Outside'", scenes.some(s => s.context === "Outside"));

                results.innerHTML = logs.join('');

            } catch (e) {
                results.innerHTML = `<div class="fail">CRITICAL ERROR: ${e.message}</div>`;
                console.error(e);
            }
        };
    </script>
</body>

</html>